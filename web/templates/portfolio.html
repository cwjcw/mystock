{% extends 'layout.html' %}
{% block content %}
<h2>盈亏概览与持仓</h2>
<form method="get" class="pnl-form range">
  <label for="start">开始日期</label>
  <input id="start" name="start" type="date" value="{{ start_date }}">
  <label for="end">结束日期</label>
  <input id="end" name="end" type="date" value="{{ end_date }}">
  <div class="actions">
    <button class="btn" type="submit">重新计算</button>
  </div>
</form>

<section class="profit-overview">
  <ul class="profit-list">
    <li class="profit-item">
      <div class="profit-line">
        <span class="profit-label">周期盈亏</span>
        <span class="profit-value {{ 'profit-positive' if realized_with_initial > 0 else 'profit-negative' if realized_with_initial < 0 else '' }}">{{ '%.2f'|format(realized_with_initial) }} 元</span>
      </div>
    </li>
    <li class="profit-item">
      <div class="profit-line">
        <span class="profit-label">总盈亏</span>
        <span class="profit-value {{ 'profit-positive' if combined_total > 0 else 'profit-negative' if combined_total < 0 else '' }}">{{ '%.2f'|format(combined_total) }} 元</span>
      </div>
      <div class="profit-extra">= 周期盈亏 + 持仓盈亏</div>
    </li>
    <li class="profit-item">
      <div class="profit-line">
        <span class="profit-label">持仓盈亏</span>
        <span class="profit-value {{ 'profit-positive' if unrealized_total > 0 else 'profit-negative' if unrealized_total < 0 else '' }}">{{ '%.2f'|format(unrealized_total) }} 元</span>
      </div>
      <div class="profit-extra">
        <div>成本：{{ '%.2f'|format(total_cost_basis) }} 元</div>
        <div>市值：{{ '%.2f'|format(total_market_value) }} 元</div>
      </div>
    </li>
    <li class="profit-item">
      <div class="profit-line">
        <span class="profit-label">当日盈亏</span>
        <span class="profit-value {{ 'profit-positive' if daily_total > 0 else 'profit-negative' if daily_total < 0 else '' }}">{{ '%.2f'|format(daily_total) }} 元</span>
      </div>
      {% set daily_stock_class = 'profit-positive' if daily_stock_pnl > 0 else 'profit-negative' if daily_stock_pnl < 0 else '' %}
      {% set daily_fund_class = 'profit-positive' if daily_fund_pnl > 0 else 'profit-negative' if daily_fund_pnl < 0 else '' %}
      <div class="profit-extra">
        <div>股票：<span class="{{ daily_stock_class }}">{{ '%.2f'|format(daily_stock_pnl) }} 元</span></div>
        <div>基金：<span class="{{ daily_fund_class }}">{{ '%.2f'|format(daily_fund_pnl) }} 元</span></div>
      </div>
    </li>
  </ul>
</section>

<section class="positions">
  <h3>当前持仓</h3>
  {% if positions %}
    <ul class="position-list">
      {% for pos in positions %}
        {% set quantity = '%.2f'|format(pos.quantity) %}
        {% set avg_cost = '%.4f'|format(pos.avg_cost) %}
        {% set price_text = '-' if pos.price is none else '%.4f'|format(pos.price) %}
        {% set change_text = '-' %}
        {% set change_class = '' %}
        {% if pos.change_pct is not none %}
          {% set change_text = '%.2f'|format(pos.change_pct) ~ '%' %}
          {% if pos.change_pct > 0 %}
            {% set change_class = 'profit-positive' %}
          {% elif pos.change_pct < 0 %}
            {% set change_class = 'profit-negative' %}
          {% endif %}
        {% endif %}
        {% set market_value_text = '-' if pos.market_value is none else '%.2f'|format(pos.market_value) %}
        {% set unrealized_text = '-' %}
        {% set unrealized_class = '' %}
        {% if pos.unrealized is not none %}
          {% set unrealized_text = '%.2f'|format(pos.unrealized) %}
          {% if pos.unrealized > 0 %}
            {% set unrealized_class = 'profit-positive' %}
          {% elif pos.unrealized < 0 %}
            {% set unrealized_class = 'profit-negative' %}
          {% endif %}
        {% endif %}
        {% set pct_text = '-' %}
        {% set pct_class = unrealized_class %}
        {% if pos.unrealized is not none and pos.cost_basis is not none and pos.cost_basis != 0 %}
          {% set pct_value = (pos.unrealized / pos.cost_basis) * 100 %}
          {% set pct_text = '%.1f'|format(pct_value) ~ '%' %}
          {% if pct_value > 0 %}
            {% set pct_class = 'profit-positive' %}
          {% elif pct_value < 0 %}
            {% set pct_class = 'profit-negative' %}
          {% else %}
            {% set pct_class = '' %}
          {% endif %}
        {% endif %}
        {% set daily_text = '-' %}
        {% set daily_class = '' %}
        {% if pos.daily_change is not none %}
          {% set daily_text = '%.2f'|format(pos.daily_change) %}
          {% if pos.daily_change > 0 %}
            {% set daily_class = 'profit-positive' %}
          {% elif pos.daily_change < 0 %}
            {% set daily_class = 'profit-negative' %}
          {% endif %}
        {% endif %}
        <li class="position-item">
          <div class="position-name-line">
            <span class="position-name">{{ pos.name or pos.symbol }}</span>
            <span class="position-symbol">{{ pos.symbol }}</span>
          </div>
          <table class="position-stats">
            <thead>
              <tr>
                <th>数量</th>
                <th>成本</th>
                <th>最新价</th>
                <th>涨跌幅</th>
                <th>市值</th>
                <th>持仓盈亏</th>
                <th>持仓盈亏%</th>
                <th>当日收益</th>
                <th>类型</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>{{ quantity }}</td>
                <td>{{ avg_cost }}</td>
                <td>{{ price_text }}</td>
                <td><span class="{{ change_class }}">{{ change_text }}</span></td>
                <td>{{ market_value_text }}</td>
                <td><span class="{{ unrealized_class }}">{{ unrealized_text }}</span></td>
                <td><span class="{{ pct_class }}">{{ pct_text }}</span></td>
                <td><span class="{{ daily_class }}">{{ daily_text }}</span></td>
                <td>{{ '股票' if pos.asset_type == 'stock' else '基金' if pos.asset_type == 'fund' else pos.asset_type }}</td>
              </tr>
            </tbody>
          </table>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="empty">暂无持仓。</div>
  {% endif %}
</section>

<section class="initial-profit">
  <h3>初始盈利记录</h3>
  <form method="post" action="{{ url_for('add_initial_profit') }}" class="initial-form">
    <label for="init_amount">金额</label>
    <input id="init_amount" name="amount" type="number" step="0.01" required>
    <div class="actions">
      <button class="btn" type="submit">新增初始盈利</button>
    </div>
    <p class="muted">日期固定为今日：{{ today_str }}</p>
  </form>
  <table border="1" cellpadding="6" cellspacing="0">
    <thead>
      <tr>
        <th>日期</th>
        <th>金额</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      {% for item in initial_profits %}
        <tr>
          <td>{{ item['profit_date'] }}</td>
          <td class="{{ 'profit-positive' if item['amount'] > 0 else 'profit-negative' if item['amount'] < 0 else '' }}">{{ '%.2f'|format(item['amount']) }}</td>
          <td>
            <form method="post" action="{{ url_for('delete_initial_profit', profit_id=item['id']) }}" onsubmit="return confirm('确认删除该记录？');">
              <button class="btn" type="submit">删除</button>
            </form>
          </td>
        </tr>
      {% else %}
        <tr>
          <td colspan="3">暂无初始盈利记录。</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endblock %}
